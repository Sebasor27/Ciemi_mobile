<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Gráficas IEPM</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="navigateToHome()">
        <ion-icon name="home-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="recargarDatos()">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="container">
    <!-- Estado de carga -->
    <ion-spinner *ngIf="isLoading" name="crescent" class="loading-spinner"></ion-spinner>

    <!-- Mensaje de error -->
    <ion-card *ngIf="error && !isLoading" color="danger">
      <ion-card-content>
        <ion-icon name="warning-outline"></ion-icon>
        {{ error }}
        <ion-button fill="outline" size="small" (click)="initializeComponent()">Reintentar</ion-button>
      </ion-card-content>
    </ion-card>

    <!-- Contenido principal -->
    <div *ngIf="!isLoading && !error && iepmData">
      
      <!-- Información del emprendedor -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ emprendedor?.nombre }}</ion-card-title>
          <ion-card-subtitle>
            IEPM Total: {{ iepmData.resultadoTotal.puntaje | number: '1.2-2' }} / 5.00
          </ion-card-subtitle>
          <ion-card-subtitle>
            Valoración: {{ iepmData.resultadoTotal.valoracion }}
          </ion-card-subtitle>
        </ion-card-header>
      </ion-card>

      <!-- Selector de tipo de gráfico -->
      <ion-segment [value]="tipoGrafico" (ionChange)="cambiarTipoGrafico($event)" class="segment-custom">
        <ion-segment-button value="bar">
          <ion-label>Barras</ion-label>
        </ion-segment-button>
        <ion-segment-button value="pie">
          <ion-label> Pastel</ion-label>
        </ion-segment-button>
        <ion-segment-button value="doughnut">
          <ion-label>Dona</ion-label>
        </ion-segment-button>
        <ion-segment-button value="radar">
          <ion-label>Radar</ion-label>
        </ion-segment-button>
      </ion-segment>

      <!-- Gráfico principal -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="bar-chart-outline"></ion-icon>
            Visualización IEPM
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="chart-container">
            <canvas #chartCanvas></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Estadísticas -->
      <ion-card *ngIf="getEstadisticas() as stats">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="analytics-outline"></ion-icon>
            Estadísticas IEPM
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-grid>
            <ion-row>
              <ion-col size="6">
                <div class="stat-item">
                  <ion-icon name="trending-up-outline" color="success"></ion-icon>
                  <div>
                    <strong>IEPM Total</strong>
                    <p>{{ stats.iepmTotal | number: '1.2-2' }} / 5.00</p>
                  </div>
                </div>
              </ion-col>
              <ion-col size="6">
                <div class="stat-item">
                  <ion-icon name="calculator-outline" color="primary"></ion-icon>
                  <div>
                    <strong>Promedio</strong>
                    <p>{{ stats.promedio }} / 5.00</p>
                  </div>
                </div>
              </ion-col>
            </ion-row>
            <ion-row>
              <ion-col size="6">
                <div class="stat-item">
                  <ion-icon name="arrow-up-outline" color="success"></ion-icon>
                  <div>
                    <strong>Máximo</strong>
                    <p>{{ stats.maximo }} / 5.00</p>
                  </div>
                </div>
              </ion-col>
              <ion-col size="6">
                <div class="stat-item">
                  <ion-icon name="arrow-down-outline" color="warning"></ion-icon>
                  <div>
                    <strong>Mínimo</strong>
                    <p>{{ stats.minimo }} / 5.00</p>
                  </div>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-content>
      </ion-card>

      <!-- Resumen de dimensiones -->
      <ion-card *ngIf="iepmData.porDimension.length > 0">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="layers-outline"></ion-icon>
            Resumen por Dimensiones
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let dimension of iepmData.porDimension">
              <ion-avatar slot="start" [style.background-color]="coloresDimensiones[dimension.idDimension - 1]">
                <span style="color: white; font-weight: bold;">{{ dimension.idDimension }}</span>
              </ion-avatar>
              <ion-label>
                <h2>{{ dimension.dimension }}</h2>
                <p>Puntaje: {{ dimension.puntaje | number: '1.2-2' }} / 5.00</p>
                <ion-progress-bar 
                  [value]="dimension.puntaje / 5" 
                  [color]="dimension.puntaje >= 4 ? 'success' : dimension.puntaje >= 2 ? 'warning' : 'danger'">
                </ion-progress-bar>
              </ion-label>
              <ion-badge 
                [color]="dimension.puntaje >= 4 ? 'success' : dimension.puntaje >= 2 ? 'warning' : 'danger'" 
                slot="end">
                {{ (dimension.puntaje / 5 * 100).toFixed(0) }}%
              </ion-badge>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>

    </div>

    <!-- Botones de acción -->
    <div class="actions" *ngIf="!isLoading && !error">
      <ion-button expand="block" color="secondary" (click)="navigateBack()">
        <ion-icon name="document-text-outline" slot="start"></ion-icon>
        Ver Resultados Completos
      </ion-button>
      <ion-button expand="block" color="tertiary" (click)="imprimir()">
        <ion-icon name="print-outline" slot="start"></ion-icon>
        Imprimir
      </ion-button>
      <ion-button expand="block" color="medium" (click)="navegarAResultados()">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Regresar
      </ion-button>
    </div>

  </div>
</ion-content>