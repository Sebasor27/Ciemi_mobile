<ion-header [translucent]="true" class="no-print">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="navigateBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Información y Resultados</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="printPage()">
        <ion-icon name="print"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="navigateToHome()">
        <ion-icon name="home"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">

  <!-- Loading Principal -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando datos del emprendedor...</p>
  </div>

  <!-- Error Principal -->
  <ion-card *ngIf="error && !isLoading" color="danger">
    <ion-card-content>
      <h2>Error</h2>
      <p>{{ error }}</p>
      <ion-button (click)="retryLoading()" fill="outline">
        <ion-icon name="refresh" slot="start"></ion-icon>
        Reintentar
      </ion-button>
    </ion-card-content>
  </ion-card>

  <!-- CONTENIDO NORMAL (solo visible cuando NO se está imprimiendo) -->
  <div *ngIf="!isPrinting && !isLoading && !error" class="normal-view">

    <!-- Header con información del emprendedor -->
    <ion-card class="info-header">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="person" class="title-icon"></ion-icon>
          {{ emprendedor?.nombre || 'Nombre no disponible' }}
        </ion-card-title>
        <ion-card-subtitle>
          ID: {{ idEmprendedor }} | Email: {{ emprendedor?.email || 'No disponible' }} | Fecha: {{ getCurrentDate() }}
        </ion-card-subtitle>
      </ion-card-header>
    </ion-card>

    <!-- Selectores de Encuestas -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="document-text-outline" slot="start"></ion-icon>
                Encuestas ICE Disponibles
              </ion-card-title>
              <ion-card-subtitle>Selecciona una encuesta para ver resultados</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <ion-item *ngIf="encuestas.length === 0" lines="none">
                <ion-label color="medium">
                  <p>No hay encuestas ICE disponibles</p>
                </ion-label>
              </ion-item>
              
              <ion-list *ngIf="encuestas.length > 0">
                <ion-radio-group [(ngModel)]="encuestaSeleccionada" (ionChange)="onEncuestaSeleccionadaChange($event)">
                  <ion-item *ngFor="let encuesta of encuestas; let i = index" lines="full">
                    <ion-radio slot="start" [value]="encuesta.idOriginal"></ion-radio>
                    <ion-label>
                      <h3>
                        <ion-text color="primary">
                          <strong>Encuesta #{{ encuesta.idMostrar }}</strong>
                        </ion-text>
                        <ion-badge *ngIf="i === 0" color="success" style="margin-left: 8px;">Reciente</ion-badge>
                      </h3>
                      <p style="margin: 4px 0;">
                        <ion-icon name="calendar-outline" size="small"></ion-icon>
                        {{ formatearFecha(encuesta.fechaAplicacion) }}
                      </p>
                    </ion-label>
                  </ion-item>
                </ion-radio-group>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>
                <ion-icon name="analytics-outline" slot="start"></ion-icon>
                Encuestas IEPM Disponibles
              </ion-card-title>
              <ion-card-subtitle>Selecciona una encuesta para ver resultados</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <ion-item *ngIf="encuestasIEPM.length === 0" lines="none">
                <ion-label color="medium">
                  <p>No hay encuestas IEPM disponibles</p>
                </ion-label>
              </ion-item>
              
              <ion-list *ngIf="encuestasIEPM.length > 0">
                <ion-radio-group [(ngModel)]="encuestaSeleccionadaIEPM" (ionChange)="onEncuestaSeleccionadaIEPMChange($event)">
                  <ion-item *ngFor="let encuesta of encuestasIEPM; let i = index" lines="full">
                    <ion-radio slot="start" [value]="encuesta.idOriginal"></ion-radio>
                    <ion-label>
                      <h3>
                        <ion-text color="secondary">
                          <strong>Encuesta #{{ encuesta.idMostrar }}</strong>
                        </ion-text>
                        <ion-badge *ngIf="i === 0" color="success" style="margin-left: 8px;">Reciente</ion-badge>
                      </h3>
                      <p style="margin: 4px 0;">
                        <ion-icon name="calendar-outline" size="small"></ion-icon>
                        {{ formatearFecha(encuesta.fechaAplicacion) }}
                      </p>
                    </ion-label>
                  </ion-item>
                </ion-radio-group>
              </ion-list>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Botones de navegación -->
    <div class="action-buttons no-print" style="margin: 20px 0;">
      <ion-button expand="block" (click)="verResultadosICE()" color="primary" [disabled]="!encuestaSeleccionada">
        <ion-icon name="document-text" slot="start"></ion-icon>
        Ver Resultados ICE
      </ion-button>
      <ion-button expand="block" (click)="verResultadosIEPM()" color="secondary" [disabled]="!encuestaSeleccionadaIEPM">
        <ion-icon name="document-text" slot="start"></ion-icon>
        Ver Resultados IEPM
      </ion-button>
      <ion-button expand="block" (click)="navegarAGraficaICE()" color="tertiary" [disabled]="!encuestaSeleccionada">
        <ion-icon name="bar-chart" slot="start"></ion-icon>
        Ver Gráfica ICE
      </ion-button>
      <ion-button expand="block" (click)="navegarAGraficaIEPM()" color="warning" [disabled]="!encuestaSeleccionadaIEPM">
        <ion-icon name="pie-chart" slot="start"></ion-icon>
        Ver Gráfica IEPM
      </ion-button>
      <ion-button expand="block" (click)="navegarAComparaciones()" color="success" [disabled]="!encuestaSeleccionada || !encuestaSeleccionadaIEPM">
        <ion-icon name="git-compare" slot="start"></ion-icon>
        Ver Comparaciones e Integración
      </ion-button>
    </div>

    <!-- Mensaje de advertencia -->
    <ion-card *ngIf="!encuestaSeleccionada || !encuestaSeleccionadaIEPM" color="warning" class="no-print">
      <ion-card-content>
        <ion-icon name="alert-circle-outline" slot="start"></ion-icon>
        <p><strong>Nota:</strong> Selecciona ambas encuestas (ICE e IEPM) para acceder a todos los resultados y funciones de comparación.</p>
      </ion-card-content>
    </ion-card>

  </div>

  <!-- ========================================== -->
  <!-- 💡 VISTA DE IMPRESIÓN UNIFICADA (SOLO VISIBLE DURANTE IMPRESIÓN) -->
  <!-- ========================================== -->
  <div id="print-report" *ngIf="isPrinting" class="print-report">

    <!-- HEADER GENERAL -->
    <div class="print-header">
      <h1>INFORME INTEGRADO DE RESULTADOS</h1>
      <p><strong>Emprendedor:</strong> {{ emprendedor?.nombre || 'No disponible' }}</p>
      <p><strong>ID:</strong> {{ idEmprendedor }} | <strong>Fecha de Generación:</strong> {{ getCurrentDate() }}</p>
      <hr />
    </div>

    <!-- 1. RESULTADOS ICE -->
    <div class="print-section">
      <h2>1. Resultados ICE (Índice de Competencias Emprendedoras)</h2>
      <p><strong>Encuesta:</strong> {{ getDescripcionEncuesta(encuestaSeleccionadaObj) }}</p>
      <div *ngIf="resultadosICE.length > 0" class="result-list">
        <div *ngFor="let item of resultadosICE" class="result-item">
          <h3>{{ item.dimension }}</h3>
          <p><strong>Puntaje:</strong> {{ item.puntaje }} | <strong>Nivel:</strong> {{ item.nivel }}</p>
          <p>{{ item.descripcion }}</p>
          <h4>Recomendaciones:</h4>
          <ul>
            <li *ngFor="let rec of item.recomendaciones">{{ rec }}</li>
          </ul>
        </div>
      </div>
      <div *ngIf="resultadosICE.length === 0" class="no-data">
        <em>No hay resultados ICE disponibles.</em>
      </div>
    </div>

    <!-- 2. GRÁFICA ICE -->
    <div class="print-section">
      <h2>2. Gráfica ICE</h2>
      <div *ngIf="datosGraficaICE" class="chart-container">
        <div class="bar-chart">
          <div *ngFor="let label of datosGraficaICE.labels; let i = index" class="bar-item">
            <div class="bar-label">{{ label }}</div>
            <div class="bar-container">
              <div 
                class="bar" 
                [style.height.%]="getBarPercentage(datosGraficaICE.data[i], datosGraficaICE.data)"
                [style.background-color]="datosGraficaICE.colores[i]">
              </div>
            </div>
            <div class="bar-value">{{ datosGraficaICE.data[i] }}</div>
          </div>
        </div>
      </div>
      <div *ngIf="!datosGraficaICE" class="no-data">
        <em>No hay gráfica ICE disponible.</em>
      </div>
    </div>

    <!-- 3. RESULTADOS IEPM -->
    <div class="print-section">
      <h2>3. Resultados IEPM (Índice de Emprendimiento y Proyecto de Mejora)</h2>
      <p><strong>Encuesta:</strong> {{ getDescripcionEncuesta(encuestaSeleccionadaIEPMObj) }}</p>
      <div *ngIf="resultadosIEPM.length > 0" class="result-list">
        <div *ngFor="let item of resultadosIEPM" class="result-item">
          <h3>{{ item.factor }}</h3>
          <p><strong>Puntaje:</strong> {{ item.puntaje }} | <strong>Nivel:</strong> {{ item.nivel }}</p>
          <p>{{ item.descripcion }}</p>
          <h4>Recomendaciones:</h4>
          <ul>
            <li *ngFor="let rec of item.recomendaciones">{{ rec }}</li>
          </ul>
        </div>
      </div>
      <div *ngIf="resultadosIEPM.length === 0" class="no-data">
        <em>No hay resultados IEPM disponibles.</em>
      </div>
    </div>

    <!-- 4. GRÁFICA IEPM -->
    <div class="print-section">
      <h2>4. Gráfica IEPM</h2>
      <div *ngIf="datosGraficaIEPM" class="chart-container">
        <div class="bar-chart">
          <div *ngFor="let label of datosGraficaIEPM.labels; let i = index" class="bar-item">
            <div class="bar-label">{{ label }}</div>
            <div class="bar-container">
              <div 
                class="bar" 
                [style.height.%]="getBarPercentage(datosGraficaIEPM.data[i], datosGraficaIEPM.data)"
                [style.background-color]="datosGraficaIEPM.colores[i]">
              </div>
            </div>
            <div class="bar-value">{{ datosGraficaIEPM.data[i] }}</div>
          </div>
        </div>
      </div>
      <div *ngIf="!datosGraficaIEPM" class="no-data">
        <em>No hay gráfica IEPM disponible.</em>
      </div>
    </div>

    <!-- 5. COMPARACIONES E INTEGRACIÓN -->
    <div class="print-section">
      <h2>5. Análisis Comparativo y Recomendaciones Integradas</h2>
      <div *ngIf="comparaciones">
        <p><strong>Correlación entre ICE e IEPM:</strong> {{ (comparaciones.correlacion * 100).toFixed(1) }}%</p>
        <div class="correlacion-meter">
          <div class="meter-background">
            <div 
              class="meter-fill" 
              [style.width.%]="getAbsoluteValue(comparaciones.correlacion * 100)"
              [class.positive]="comparaciones.correlacion > 0"
              [class.negative]="comparaciones.correlacion < 0">
            </div>
          </div>
        </div>
        <h3>Análisis</h3>
        <p>{{ comparaciones.analisis }}</p>
        <h3>Recomendaciones Integradas</h3>
        <ol>
          <li *ngFor="let rec of comparaciones.recomendacionesIntegradas">{{ rec }}</li>
        </ol>
      </div>
      <div *ngIf="!comparaciones" class="no-data">
        <em>No hay análisis comparativo disponible.</em>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="print-footer">
      <p>Informe generado automáticamente por CIEMI - {{ getCurrentDate() }}</p>
    </div>

  </div>

  <!-- Loading de impresión -->
  <div *ngIf="isPrinting" class="loading-container print-loading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Generando informe para impresión...</p>
  </div>

</ion-content>