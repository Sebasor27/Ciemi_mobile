<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <!-- ERROR CORREGIDO: router debe ser público en el componente -->
      <ion-button (click)="navigateToHome()" fill="clear">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Resultados de Evaluación</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="imprimir()" fill="clear">
        <ion-icon name="print" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="circular" color="primary"></ion-spinner>
    <ion-text>
      <p>Cargando resultados...</p>
    </ion-text>
  </div>

  <!-- Error State -->
  <ion-card *ngIf="error && !isLoading" color="danger">
    <ion-card-header>
      <ion-card-title>Error</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text>{{ error }}</ion-text>
    </ion-card-content>
  </ion-card>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !error" class="results-container">
    
    <!-- Información del Emprendedor -->
    <ion-card class="emprendedor-card">
      <ion-card-header>
        <ion-card-title>Información del Emprendedor</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item lines="none">
          <ion-icon name="person" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h2>{{ emprendedor?.nombre || 'No disponible' }}</h2>
            <p>ID: {{ idEmprendedor }}</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-icon name="calendar" slot="start" color="primary"></ion-icon>
          <ion-label>
            <h3>Fecha de Evaluación</h3>
            <p>{{ getEncuestaFecha() }}</p>
          </ion-label>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Selector de Encuestas ICE -->
    <ion-card class="selector-card">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="document-text" color="primary"></ion-icon>
          Evaluación ICE (Índice de Competencias Emprendedoras)
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-select
            [(ngModel)]="encuestaSeleccionada"
            (ionChange)="onEncuestaSeleccionadaChange($event)"
            placeholder="Seleccionar encuesta ICE"
            interface="popover">
            <ion-select-option *ngFor="let encuesta of encuestas" [value]="encuesta.idEncuesta">
              Encuesta {{ encuesta.idEncuesta }} - {{ getFechaEvaluacion(encuesta) }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Resultados ICE -->
    <div *ngIf="encuestaSeleccionada && resultados.length > 0" class="ice-results">
      
      <!-- Resumen General -->
      <ion-card class="summary-card">
        <ion-card-header>
          <ion-card-title>Resumen General ICE</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="summary-grid">
            <div class="summary-item">
              <ion-text color="primary">
                <h1>{{ calcularIceGeneral().toFixed(3) }}</h1>
              </ion-text>
              <ion-text>
                <p>Puntuación Total</p>
              </ion-text>
            </div>
            <div class="summary-item">
              <ion-text [color]="getNivelIceGeneral().nivel === 'Alto' ? 'success' : getNivelIceGeneral().nivel === 'Medio' ? 'warning' : 'danger'">
                <h2>{{ getNivelIceGeneral().nivel }}</h2>
              </ion-text>
              <ion-text>
                <p>{{ getNivelIceGeneral().valoracion }}</p>
              </ion-text>
            </div>
          </div>
          <ion-text>
            <p><strong>Recomendación:</strong> {{ getNivelIceGeneral().acciones }}</p>
          </ion-text>
        </ion-card-content>
      </ion-card>

      <!-- Controles del Gráfico -->
      <ion-card class="chart-controls">
        <ion-card-header>
          <ion-card-title>Visualización de Competencias</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-item>
            <ion-label>Tipo de Gráfico:</ion-label>
            <ion-select [(ngModel)]="tipoGrafico" (ionChange)="cambiarTipoGrafico($event.detail.value)">
              <ion-select-option value="pie">Circular</ion-select-option>
              <ion-select-option value="doughnut">Dona</ion-select-option>
              <ion-select-option value="bar">Barras</ion-select-option>
              <ion-select-option value="radar">Radar</ion-select-option>
            </ion-select>
          </ion-item>
          <div class="chart-actions">
            <ion-button (click)="recrearGrafico()" fill="outline" size="small">
              <ion-icon name="refresh" slot="start"></ion-icon>
              Recrear Gráfico
            </ion-button>
            <ion-button (click)="diagnosticarEstado()" fill="outline" size="small" color="secondary">
              <ion-icon name="bug" slot="start"></ion-icon>
              Diagnosticar
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Gráfico de Competencias -->
      <ion-card class="chart-card">
        <ion-card-content>
          <div class="chart-container">
            <canvas #pieChart></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Tabla de Competencias -->
      <ion-card class="competencias-table">
        <ion-card-header>
          <ion-card-title>Detalle por Competencias</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <ion-item *ngFor="let resultado of getResultadosFiltrados(); let i = index" lines="full">
              <div class="competencia-item" slot="start">
                <div 
                  class="color-indicator" 
                  [style.background-color]="resultado.color">
                </div>
              </div>
              <ion-label>
                <h3>{{ resultado.nombre }}</h3>
                <div class="competencia-details">
                  <ion-text color="medium">
                    <p>Puntuación: {{ resultado.puntuacionCompetencia.toFixed(3) }}</p>
                  </ion-text>
                  <ion-text 
                    [color]="resultado.nivel === 'Alto' ? 'success' : resultado.nivel === 'Medio' ? 'warning' : 'danger'">
                    <p>Nivel: {{ resultado.nivel }}</p>
                  </ion-text>
                  <div class="progress-bar">
                    <div 
                      class="progress-fill" 
                      [style.width.%]="getCompetenciaPercentage(resultado)"
                      [style.background-color]="resultado.color">
                    </div>
                  </div>
                </div>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Selector de Encuestas IEPM -->
    <ion-card class="selector-card" *ngIf="encuestasIEPM.length > 0">
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="analytics" color="secondary"></ion-icon>
          Evaluación IEPM (Índice de Emprendimiento y Productividad Municipal)
        </ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-item>
          <ion-select
            [(ngModel)]="encuestaSeleccionadaIEPM"
            (ionChange)="onEncuestaSeleccionadaIEPMChange($event)"
            placeholder="Seleccionar encuesta IEPM"
            interface="popover">
            <ion-select-option *ngFor="let encuesta of encuestasIEPM" [value]="encuesta.idEncuesta">
              Encuesta {{ encuesta.idEncuesta }} - {{ getFechaEvaluacion(encuesta) }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-card-content>
    </ion-card>

    <!-- Resultados IEPM -->
    <div *ngIf="showIEPM && iepmData" class="iepm-results">
      
      <!-- Resumen IEPM -->
      <ion-card class="iepm-summary">
        <ion-card-header>
          <ion-card-title>Resumen IEPM</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="iepm-summary-grid">
            <div class="iepm-item">
              <ion-text color="secondary">
                <h1>{{ iepmData.resultadoTotal.puntaje.toFixed(2) }}</h1>
              </ion-text>
              <ion-text>
                <p>Puntuación IEPM</p>
              </ion-text>
            </div>
            <div class="iepm-item">
              <ion-text [color]="getNivelPuntaje(iepmData.resultadoTotal.puntaje).color">
                <h2>{{ iepmData.resultadoTotal.valoracion }}</h2>
              </ion-text>
              <ion-text>
                <p>Valoración</p>
              </ion-text>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Gráfico IEPM -->
      <ion-card class="iepm-chart-card">
        <ion-card-header>
          <ion-card-title>Evaluación por Dimensiones</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="chart-container">
            <canvas #iepmChart></canvas>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Dimensiones IEPM -->
      <ion-card class="dimensiones-card">
        <ion-card-header>
          <ion-card-title>Análisis por Dimensiones</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-list>
            <div *ngFor="let dimension of iepmData.porDimension" class="dimension-section">
              <ion-item color="light">
                <ion-icon [style.color]="getColorDimension(dimension.idDimension)" name="layers" slot="start"></ion-icon>
                <ion-label>
                  <h2>{{ dimension.dimension }}</h2>
                  <div class="dimension-score">
                    <ion-text color="dark">
                      <p>Puntuación: {{ dimension.puntaje.toFixed(2) }}/5.0 ({{ dimension.porcentaje.toFixed(1) }}%)</p>
                    </ion-text>
                    <ion-badge [color]="getNivelPuntaje(dimension.puntaje).nivel === 'Alto' ? 'success' : getNivelPuntaje(dimension.puntaje).nivel === 'Medio' ? 'warning' : 'danger'">
                      {{ getNivelPuntaje(dimension.puntaje).nivel }}
                    </ion-badge>
                  </div>
                </ion-label>
              </ion-item>
              
              <!-- Indicadores de esta dimensión -->
              <div class="indicadores-list">
                <ion-item *ngFor="let indicador of getIndicadoresPorDimension(dimension.idDimension)" lines="inset">
                  <ion-label>
                    <h3>{{ indicador.indicador }}</h3>
                    <div class="indicador-details">
                      <ion-text color="medium">
                        <p>Puntuación: {{ indicador.puntaje.toFixed(2) }}/5.0</p>
                      </ion-text>
                      <div class="progress-bar-small">
                        <div 
                          class="progress-fill-small" 
                          [style.width.%]="indicador.porcentaje"
                          [style.background-color]="getColorDimension(dimension.idDimension)">
                        </div>
                      </div>
                    </div>
                  </ion-label>
                </ion-item>
              </div>
            </div>
          </ion-list>
        </ion-card-content>
      </ion-card>

      <!-- Recomendaciones -->
      <ion-card class="recommendations-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="bulb" color="warning"></ion-icon>
            Recomendaciones de Mejora
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-text>
            <h3>{{ iepmData.accionRecomendada.descripcion }}</h3>
            <p>{{ iepmData.accionRecomendada.recomendaciones }}</p>
            <p><strong>Rango de aplicación:</strong> {{ iepmData.accionRecomendada.rango }}</p>
          </ion-text>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Botón de Comentarios -->
    <ion-button 
      (click)="toggleComentarios()" 
      expand="block" 
      fill="outline" 
      color="tertiary"
      class="comments-toggle">
      <ion-icon name="chatbubbles" slot="start"></ion-icon>
      {{ showSideComments ? 'Ocultar' : 'Mostrar' }} Comentarios
    </ion-button>

    <!-- Panel de Comentarios -->
    <ion-card *ngIf="showSideComments" class="comments-card">
      <ion-card-header>
        <ion-card-title>Comentarios y Observaciones</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-textarea
          [(ngModel)]="comentarios"
          placeholder="Agregar comentarios sobre la evaluación..."
          rows="6"
          maxlength="1000">
        </ion-textarea>
        <div class="comments-actions">
          <!-- ERROR CORREGIDO: loadSavedComments() debe ser público en el componente -->
          <ion-button (click)="reloadComments()" fill="outline" size="small">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Recargar
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Acciones Finales -->
    <div class="final-actions">
      <ion-button (click)="imprimir()" expand="block" color="primary">
        <ion-icon name="print" slot="start"></ion-icon>
        Imprimir Resultados
      </ion-button>
      
      <ion-button (click)="verificarDatos()" expand="block" fill="outline" color="secondary">
        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
        Verificar Datos
      </ion-button>
    </div>
  </div>

  <!-- Área de impresión oculta -->
  <div #printContent class="print-content" style="display: none;">
    <!-- Contenido específico para impresión -->
    <div class="print-header">
      <h1>Resultados de Evaluación Emprendedora</h1>
      <p>Emprendedor: {{ emprendedor?.nombre }}</p>
      <p>Fecha: {{ getCurrentDate() }}</p>
      <hr>
    </div>
    <!-- El contenido se puede expandir según necesidades -->
  </div>

</ion-content>